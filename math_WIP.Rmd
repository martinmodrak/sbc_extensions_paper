---
title: "R Notebook"
output: html_notebook
---

## Definitions

Note on notation: we will denote the integral of $f(x)$ w.r.t $x$ over domain $X$ as $\int_X \mathrm{d}x \: f(x)$.

$$
\pi_{\text{joint}}(y, \theta) = \pi_{\text{obs}}(y | \theta) \pi_\text{prior}(\theta)\\
\pi_\text{marg}\left(y \right) = \int_\Theta \mathrm{d} \theta \: \pi_{\text{obs}}(y | \theta) \pi_\text{prior}(\theta)\\
\pi_{\text{post}}(\theta | y) = \frac{\pi_{\text{obs}}(y | \theta) \pi_\text{prior}(\theta)}{\pi_\text{marg}\left(y \right)}
$$

Alternate $q$ def:

Given a model, fitting algorithm and a function $f$, we define fitted pushforward CDF

$$
C_{\phi,f}(s | y) = \int_{\Theta}\mathrm{d}\theta\mathbb{\,I}\left[f\left(\theta, y \right) \leq s\right]\phi\left(\theta | y\right)
$$ 

and true pushforward CDF 

$$
C_{f}\left( s | y\right)=\int_{\Theta}\mathrm{d}\theta\mathbb{\,I}\left[f\left(\theta, y \right) \leq s\right]\pi_{\text{post}}(\theta | y)  \\


$$

Where $\mathbb{I}$ is the indicator function

$$
D_{\phi,f}(s | y) = \int \mathrm{d}\theta \: \phi(\theta | y) \mathbb{I}\left[ f(\theta, y) = s \right]
$$


For fixed $\tilde\theta$ and $y$ we define the continuous rank CDF
$r_{\phi,f}(x, \tilde\theta | y)$ as

$$
e \sim \text{Uniform}_c(0, 1)\\
r_{\phi,f}(x, \tilde\theta | y) = 
\mathbb{P}\left(C_{\phi,f} \left(f \left(\tilde\theta, y \right) | y \right) - e D_{\phi,f} \left(f \left(x, \tilde\theta, y \right) | y \right) < x\right)
$$

where $\text{Uniform}_c$ is the continous uniform distribution.

$$
r_{\phi,f}(x, \tilde\theta | y) = 
\begin{cases}
  0 & \text{if } x < C_{\phi,f} \left(f \left(\tilde\theta, y \right) | y \right) - D_{\phi,f} \left(f \left(\tilde\theta, y \right) | y \right) \\
  1 - \frac{C_{\phi,f} \left(f \left(\tilde\theta, y \right) | y \right) - x}{D_{\phi,f} \left(f \left(\tilde\theta, y \right) | y \right)} & 
    \text{if } D_{...} > 0 \text{ and } C_{\phi,f} \left(f \left(\tilde\theta, y \right) | y \right) - D_{\phi,f} \left(f \left(\tilde\theta, y \right) | y \right) \leq x < C_{\phi,f} \left(f \left(\tilde\theta, y \right) | y \right) \\
  1 & \text{if } x \geq C_{\phi,f} \left(f \left(\tilde\theta, y \right) \right) 
\end{cases} =
$$

TODO: figure out exact inequalities above

```{r}
x <- 0.2
f <- 1

c_phi <- function(x) { pbinom(x, size = 2, prob = 0.5) }

inv_c_phi <- function(x) { qbinom(x, size = 2, prob = 0.5) }

inv_c_m_d_phi <- function(x) { }


```


$$
q_{\phi,f}(x|y) = 
\int_\Theta \mathrm{d} \tilde\theta \: \pi_\text{post}(\tilde\theta | y) r_{\phi,f}(x, \tilde\theta | y)\\

$$


If I end up needing it, I can make it look better (https://discourse.mc-stan.org/t/sbc-math-proofs/27655/12?u=martinmodrak) but that might in fact end up not being necessary.

$$
q\left(x\mid y\right)=C_{f}\left(s\mid y\right)+\frac{D_{f}\left(s\mid y\right)}{D_{\phi,f}\left(s\mid y\right)}\left(x-C_{\phi,f}\left(s\mid y\right)\right) \\
s=\sup\left\{ s^{\prime}:C_{\phi,f}\left(s^{\prime}\mid y\right)<x\right\}
$$

Presumably, my definition of $C^{-1}$ consistent with Niko's $s$? 

$$
C^{-1}_{\phi,f}(x | y) = \inf\{ s^{\prime} : x \leq C_{\phi, f}(s^{\prime} | y)\} \\
s=\sup\left\{ s^{\prime}:C_{\phi,f}\left(s^{\prime}\mid y\right)<x\right\}
$$

Almost!

### Sample-based

$$
R_{\phi,f}(i, \tilde\theta, y) = \mathbb{P} \left(N_{\mathtt{less}} + K \leq i \right) \\

Q_{\phi,f}(i | y) = \int_\Theta \mathrm{d}\tilde\theta \: \pi_\text{post}(\tilde\theta|y)  R_{\phi,f}(i, \tilde\theta, y)
$$

passes sample-based SBC iff

$$
\forall i \in 0, \dots, M - 1: \int_Y \: \mathrm{d}y \: Q_{\phi,f}(i |y) \pi_\text{marg}(y) = \frac{i+1}{M + 1}
$$

Equivalence with the procedural definition:

$$
\int_Y \: \mathrm{d}y \: Q_{\phi,f}(i |y) \pi_\text{marg}(y) = 
\int_Y \: \mathrm{d}y  \int_\Theta \mathrm{d}\tilde\theta \: \pi_\text{post}(\tilde\theta|y)  R_{\phi,f}(i, \tilde\theta, y) \pi_\text{marg}(y) = \\
\int_\Theta \mathrm{d}\tilde\theta   \int_Y \: \mathrm{d}y \: \pi_\text{prior}(\tilde\theta)\pi_\text{lik}(y | \tilde\theta)  R_{\phi,f}(i, \tilde\theta, y) (y)


$$

## Ties/no ties correspondance

A posterior family $\phi$ has ties w.r.t model $\pi$ and function $f$ when 

$$
\int_Y \mathrm{d}y \int_\Theta \mathrm{d} \tilde\theta D_{\phi,f}(f(\tilde\theta,y) | y) > 0
$$

Given a posterior family $\phi$ which has ties wrt model $\pi$ and function $f$ we can construct a model $\pi^\prime$, posterior family $\phi^\prime$ and function $f^\prime$ such that $\phi^\prime$ has no ties wrt $\pi^\prime$ and $f^\prime$ and


$$
\forall y \in Y, x \in [0,1]: q^\pi_{\phi,f}(x | y) = q^{\pi^\prime}_{\phi,f}(x | y) \\
\forall y \in Y, i \in 0, \dots, M - 1: Q^\pi_{\phi,f}(i | y) = Q^{\pi^\prime}_{\phi,f}(i | y)
$$

The construction:

For each $y$ there can only be countable number of collisions with positive probability. So we can define:

$$
W_{\phi,f}(y) = \{w : D_{\phi,f}(w | y) > 0 \} \\
L_{\phi,f}(s, y) = |\{w \in W_{\phi,f}(y) | w < s\}|
$$

$$
\Theta^\prime = \Theta \times [0, 1] \\
\pi^\prime_\text{joint}(y, \theta, u) =  \pi_\text{joint}(y, \theta) \\
\phi^\prime(\theta, u, y) = \phi(\theta, y) \\
f^\prime(\theta, u, y) = \begin{cases}
f(\theta,y) + L_{\phi,f}(\theta,y) + u& \text{if } f(\theta,y) \in W_{\phi,f}(y) \\
f(\theta,y) + L_{\phi,f}(\theta,y) & \text{otherwise}
\end{cases}
$$

By inspection, there are no ties. The ordering of non-colliding elements hasn't changed and the order among those previously equal is uniformly random. 

Additionally $\phi = \pi_{post}$ if and only if $\phi^\prime = \pi^\prime_\text{post}$.


## Correct posterior passes continuous SBC

outline: $C_f(C^{-1}_f(x|y)|y)$ is for a given $y$ either identity or "blocky". The tiebraking exactly removes the blocks, so we have the stronger condition

$$
\phi = \pi_{post}: 
\forall y \in Y, x \in [0,1] : q_{\phi,f}(x|y) = x
$$

Presumably, if the above condition holds, than it also holds for any transform of $f$, even if the posterior is incorrect (TODO check).

### The SBC Gap

If

$$
\forall y \in Y, x \in [0,1] : q_{\phi,f}(x|y) = x
$$
then 

$$
\forall y \in Y, s \in \mathbb{R}: C_{\phi,f}(s|y) = C_f(s|y)
$$

i.e. the pushfoward along $f$ is exactly correct.

This unifies all of the "failures" of SBC.

## Continuous SBC implies sample SBC

By contradiction: if sample ranks are non-uniform, there has to be some $x: \int_Y \mathrm{d} y: q_{\phi,f}(x|y) \neq x$.

take lowest $k$ where 

$$
\mathbf{P}(N_\text{less} + K = k) \neq \frac{1}{M + 1}
$$

$$
\mathbb{E}(K|y) = \int_\Theta \mathrm{d}\theta \pi(\theta|y) \sum_{i=0}^M \mathtt{binomial\_pmf}\left(i | D_{\phi,f} \left(f \left(\theta, y \right) | y \right), M \right)\frac{i}{2}  = \\
\int_\Theta \mathrm{d}\theta \:\pi(\theta|y) \frac{D_{\phi,f} \left(f \left(\theta, y \right) | y \right) M}{2}
\\
\mathbb{E}(N_\text{less}|y) = M\int_0^1 \mathrm{d}x C_{\phi,f}(C^{-1}_f(x | y) | y)
$$

Case 1

$$
\mathbb{P}(N_\text{less} + K \leq k) > \frac{k}{M + 1}
$$

I choose $\tilde\theta$




## Sample SBC for all $M$ implies continuous SBC

Prove that $q$ is the limit of fractional rank distribution as $M \to \infty$

## Integral representation of SBC

$$
  \forall x \in [0,1]: \notag\\ 
  \int_Y \mathrm{d}y \int_\Theta \mathrm{d} \tilde\theta \:
  \mathbb{I}\left[
  \int_\Theta \mathrm{d}\theta \: \left(\mathbb{I}[f(\theta, y) < f(\tilde\theta, y)] \phi(\theta, y)\right)  < x
  \right]  \pi(y | \tilde\theta) \pi(\tilde\theta) = x
$$

## Convex combinations

$$
  \int_Y \mathrm{d}y \int_\Theta \mathrm{d} \tilde\theta \:
  \mathbb{I}\left[
  \int_\Theta \mathrm{d}\theta \: \left(\mathbb{I}[f(\theta, y) < f(\tilde\theta, y)] (a\phi(\theta, y) + (1-a)\omega(\theta, y))\right)  < x
  \right]  \pi(y | \tilde\theta) \pi(\tilde\theta) = \\
  \int_Y \mathrm{d}y \int_\Theta \mathrm{d} \tilde\theta \:
  \mathbb{I}\left[
  a\int_\Theta \mathrm{d}\theta \: \left(\mathbb{I}[f(\theta, y) < f(\tilde\theta, y)] \phi(\theta, y)\right) +
  (1 - a)\int_\Theta \mathrm{d}\theta \: \left(\mathbb{I}[f(\theta, y) < f(\tilde\theta, y)] \omega(\theta, y)\right)  < x
  \right]  \pi(y | \tilde\theta) \pi(\tilde\theta) =   
$$

## Non-monotonous functions - simple case

### Lemma 1

Take $\phi$, $f,g: Y \times \Theta \to \mathbb{R}, h: \mathbb{R} \to \mathbb{R}$ such that $\forall y \in Y, \theta \in \mathbb{R}: g(\theta, y) = h(f(\theta, y)$.  Disjoint intervals $[a_1, b_1], [a_2,b_2], [a_3, b_3] \subset \mathbb{R}, a_1 < b_1 < a_2 < b_2 < a_3 < b_3$ such that 

$$
\forall x_1 \in [a_1, b_1], x_2 \in [a_2,b_2], x_3 \in [a_3, b_3]: h(x_1) \leq h(x_2),  h(x_3) \leq h(x_2)
$$

$\phi$ passes SBC for $f$.

Disjoint $Y_1, Y_2 \subset Y, Y_3 = Y \setminus  (Y_1 \cup Y_2)$

$$
q_{\phi,f}(x | y) = \begin{cases}
x & \text{for } y \in Y_3 \\
x & \text{for } y \in Y_1 \cup Y_2, C_{\phi,f}(C^{}) \\
> x & \text{for } y \in Y_1, C_f(C^{-1}_{\phi,f}(a_2 | y) | y) < x < C_f(C^{-1}_{\phi,f}(b_2 | y) | y) \\
> x & \text{for } y \in Y_2, C_f(C^{-1}_{\phi,f}(a_3 | y) | y) < x < C_f(C^{-1}_{\phi,f}(b_3 | y) | y) \\
< x & \text{for } y \in Y_1, C_f(C^{-1}_{\phi,f}(a_3 | y) | y) < x < C_f(C^{-1}_{\phi,f}(b_3 | y) | y) \\
< x & \text{for } y \in Y_2, C_f(C^{-1}_{\phi,f}(a_2 | y) | y) < x < C_f(C^{-1}_{\phi,f}(b_2 | y) | y)
\end{cases}
$$

$$
\forall y_1 \in Y_1, y_2 \in Y_2: \\
C_f(a_2 | y_1) < C_f(a_2 | y_2) \\
C_f(b_2 | y_1) < C_f(b_2 | y_2) \\
C_f(a_3 | y_1) < C_f(a_3 | y_2) \\
C_f(b_3 | y_1) < C_f(b_3 | y_2)
$$

Now $\phi$ does not pass SBC for $g$.


(we can prove the other non-monotonous ordering by using $-h$, which maintains SBC)

### Lemma 2

Take $\Theta = \mathbb{R}$ and $\text{id} : Y \times \mathbb R \to \mathbb{R}, \text{id}(y, \theta) = \theta$   $C_\text{id}(s|y)$ is invertible over the domain of $f$ for all $y$. Take any continuous, almost everywhere smooth bijection $u: [0,1] \to [0,1], u(0) = 0, u(1) = 1$ and disjoint $Y_1, Y_2 \subset Y$ (with non-zero mass).  

$$
a,b \in [0,1]\\
\frac{a}{b} = \frac{\int_{y \in Y_2} \mathrm{d}y \: \pi_\text{marg}(y)}{\int_{y \in Y_1} \mathrm{d}y \: \pi_\text{marg}(y)}
$$

$$
v(x) = a u(x) + (1-a)x\\
w(x) = b (2x - u(x)) + (1-b)x\\

t_1(\theta, y) =  C^{-1}_\text{id}(v(C_\text{id}(\theta|y)) | y)\\
t_2(\theta, y) =  C^{-1}_\text{id}(w(C_\text{id}(\theta|y)) | y)
$$

$$
C^{-1}_\text{id}(v_i(C_\text{id}(\theta|y)) | y) = x \\
v_i(C_\text{id}(\theta|y)) = C_\text{id}(x |y) \\
C_\text{id}(\theta|y) = v^{-1}(C_\text{id}(x |y)) \\
\theta = C^{-1}_\text{id}(v^{-1}(C_\text{id}(x |y)) | y) \\
$$

$t_{1,2}$ are invertible and we can define:

TODO: Omega and w are similar visually, change

$$
\omega(\theta|y) = \begin{cases}
  \pi_\text{post}(t^{-1}_1(\theta,y)|y) \frac{\partial t^{-1}_1}{\partial \theta}(\theta, y) | y) & \text{if } y \in Y_1 \\
  \pi_\text{post}(t^{-1}_2(\theta,y)|y) \frac{\partial t^{-1}_2}{\partial \theta}(\theta, y) | y) & \text{if } y \in Y_2 \\
  \pi_\text{post}(\theta | y) & \text{otherwise}
\end{cases}
$$

now $\omega$ satisfies SBC for $\text{id}$.


$$
y \in Y_1: C_{\omega,\text{id}}(s|y) = \int_{\Theta}\mathrm{d}\theta\mathbb{\,I}\left[\theta \leq s\right]\omega\left(\theta | y\right) = \\
\int_{\Theta}\mathrm{d}\theta\mathbb{\,I}\left[\theta \leq s\right]\pi_\text{post}(t^{-1}_1(\theta,y)|y) \frac{\partial t^{-1}_1}{\partial \theta}(\theta, y) | y) = \\
= \int_{\Theta}\mathrm{d}\bar\theta\mathbb{\,I}\left[t_1(\theta,y) \leq s\right]\pi_\text{post}(\bar\theta,y) = C_{t_1}(s|y) \\


$$

$$
y \in Y_1: q_{\omega,\text{id}}(x | y) = C_\text{id} \left(C^{-1}_{\omega,\text{id}}(x | y) | y \right) =
  C_\text{id} \left(C^{-1}_{t_1}(x | y) | y \right) = 
  \int \mathrm{d}\theta \: \mathbb{I}\left[\theta< C^{-1}_{t_1}(x | y)\right]\pi_\text{post}(\theta|y) = \\
  = \int \mathrm{d}\theta \: \mathbb{I}\left[C_{t_1}(\theta |y)< x\right]\pi_\text{post}(\theta|y) = \\
  = \int \mathrm{d}\theta \: \mathbb{I}\left[\int \mathrm{d}\tilde\theta\: \mathbb{I}\left[t_1(\tilde\theta, y) < \theta \right] \pi_\text{post}(\tilde\theta|y) < x\right]\pi_\text{post}(\theta|y) = \\
  = \int \mathrm{d}\theta \: \mathbb{I}\left[\int \mathrm{d}\tilde\theta\: \mathbb{I}\left[\tilde\theta < t_1^{-1}(\theta, y) \right] \pi_\text{post}(\tilde\theta|y) < x\right]\pi_\text{post}(\theta|y) = \\
  = \int \mathrm{d}\theta \: \mathbb{I}\left[C_\text{id}(t_1^{-1}(\theta, y)|y) < x\right]\pi_\text{post}(\theta|y) = \\
  = \int \mathrm{d}\theta \: \mathbb{I}\left[\theta < t_1(C^{-1}_\text{id}(x|y)\right]\pi_\text{post}(\theta|y) = \\
  = C_\text{id}\left(t_1(C_\text{id}^{-1}(x|y), y) \right) = v(x)
  
$$

Analogously

$$
y \in Y_2: q_{\omega,\text{id}}(x | y)  = w(x)
$$
So we have 

$$
\int_Y \mathrm{d}y \: q_{\omega,\text{id}}(x | y) \pi_\text{marg}(y) = \\
\int_{Y_1} \mathrm{d}y \: q_{\omega,\text{id}}(x | y) \pi_\text{marg}(y) + \int_{Y_2} \mathrm{d}y \: q_{\omega,\text{id}}(x | y) \pi_\text{marg}(y) + \int_{Y \setminus Y_1 \cup Y_2} \mathrm{d}y \: q_{\omega,\text{id}}(x | y) \pi_\text{marg}(y) = \\
v(x) \int_{Y_1} \mathrm{d}y \: \pi_\text{marg}(y) + w(x)\int_{Y_2} \mathrm{d}y\pi_\text{marg}(y) + x \int_{Y \setminus Y_1 \cup Y_2} \mathrm{d}y \: \pi_\text{marg}(y) = \\
(a u(x) + (1-a)x)\int_{Y_1} \mathrm{d}y \: \pi_\text{marg}(y) + (b (2x - u(x)) + (1-b)x)\int_{Y_2} \mathrm{d}y\pi_\text{marg}(y) + x \int_{Y \setminus Y_1 \cup Y_2} \mathrm{d}y \: \pi_\text{marg}(y) =\\
u(x) a \int_{Y_1} \mathrm{d}y \: \pi_\text{marg}(y) + b(2x - u(x)) \int_{Y_2} \mathrm{d}y\pi_\text{marg}(y) + x \left( \int_{Y \setminus Y_1 \cup Y_2} \mathrm{d}y \: \pi_\text{marg}(y) + (1-a)\int_{Y_1} \mathrm{d}y \: \pi_\text{marg}(y) + (1-b)\int_{Y_2} \mathrm{d}y\pi_\text{marg}(y)\right) \\
$$

We note that from requirements on $a,b$ we have $a \int_{Y_1} \mathrm{d}y \: \pi_\text{marg}(y) = b \int_{Y_2} \mathrm{d}y \: \pi_\text{marg}(y)$ and $u(x) + u^{-1}(x)$ se we have

$$
\int_Y \mathrm{d}y \: q_{\omega,\text{id}}(x | y) \pi_\text{marg}(y) = \\
\left(u(x) + 2x - u(x)\right)\left( a \int_{Y_1} \mathrm{d}y \: \pi_\text{marg}(y)\right) + x \left(1 - 2a \int_{Y_1} \mathrm{d}y \: \pi_\text{marg}(y) \right) = x \\

$$

$$
u(x) + v(x) = 2x \\
v(x) = 2x - u(x)
$$



## Bernoulli example

$$
q_{\phi,f}(x | 0) + q_{\phi,f}(x | 1) = x \\
C_f(C^{-1}_{\phi,f}(x | 0) | 0) + C_f(C^{-1}_{\phi,f}(x | 1) | 1) = x
$$

Correct solution

$$
\begin{align}
    \pi_\text{post}(\theta | 0) = \mathrm{Beta}(\theta | 1, 2) = 2(1-\theta) \notag\\
    \pi_\text{post}(\theta | 1) = \mathrm{Beta}(\theta | 2, 1) = 2\theta 
\end{align}
$$

$f_1$ - identity function (assuming $0 \leq s \leq 1$)

$$
C_{f_1}(s | 0) = \int_0^s \mathrm{d}\theta \: 2(1 - \theta)  =  2s - s^2 \\
C_{f_1}(s | 1) = \int_0^s \mathrm{d}\theta \: 2\theta = s^2 \\
$$

We'll denote 

$$
\Phi(s | y) = \int_0^x \mathrm{d}\theta \: \phi(\theta, y) = C_{\phi, f_1}(s | y) \\
\Phi^{-1}(x | y) = C_{\phi, f_1}^{-1}(x | y)
$$



$$
f_3(y, \theta) = \begin{cases}\theta&  \text{for } \theta < \frac{1}{2} \\ \theta - 1,&  \text{otherwise} \end{cases}
$$

(assuming $-\frac{1}{2} \leq s \leq \frac{1}{2}$)

$$
C_{f_3}(s | 0) = \int_0^1 \mathrm{d}\theta \: \mathbb{I}\left[f_3(\theta) \leq s\right] (2 - 2\theta) = 
\begin{cases}
 \int_{\frac{1}{2}}^{s + 1} \mathrm{d}\theta \: (2 - 2\theta)  & \text{for } s < 0 \\
 \int_{\frac{1}{2}}^{1} \mathrm{d}\theta (2 - 2\theta) + \int_{0}^{s} \mathrm{d}\theta (2 - 2\theta) & \text{otherwise}
\end{cases} = \\
= \begin{cases}
 \frac{1}{4} - s^2& \text{for } s < 0 \\
 \frac{1}{4} + 2 s - s^2  & \text{otherwise}
\end{cases}
\\
C_{f_3}(s | 1) = 
\begin{cases}
 \int_{\frac{1}{2}}^{s + 1} \mathrm{d}\theta \: 2\theta  & \text{for } s < 0 \\
 \int_{\frac{1}{2}}^{1} \mathrm{d}\theta \: 2\theta + \int_{0}^{s} \mathrm{d}\theta \: 2\theta & \text{otherwise}
\end{cases} 
= \begin{cases}
 \frac{3}{4} + 2s + s^2& \text{for } s < 0 \\
 \frac{3}{4} + s^2  & \text{otherwise}
\end{cases}
$$

$$
h_y = \Phi \left(\frac{1}{2} | y\right) \\
C_{\phi,f_3}(s | y) = 
\begin{cases}
 \int_{\frac{1}{2}}^{s + 1} \mathrm{d}\theta \: \phi(\theta, y)  & \text{for } s < 0 \\
 \int_{\frac{1}{2}}^{1} \mathrm{d}\theta \: \phi(\theta, y) + \int_{0}^{s} \mathrm{d}\theta \: \phi(\theta, y) & \text{otherwise} 
\end{cases}  = \\
= \begin{cases}
  \Phi(s + 1| y) - h_y & \text{for } s < 0 \\
1 -   h_y + \Phi(s | y)& \text{otherwise} 
\end{cases}
$$
Solving for the inverse:

$$
z = \begin{cases}
  \Phi(s + 1| y) - h_y & \text{for } s < 0 \\
1 -   h_y + \Phi(s | y)& \text{otherwise} 
\end{cases} \\


z_1 = \Phi(s + 1| y) - h_y\\
z_1 + h_y = \Phi(s + 1| y)\\
\Phi^{-1}(z_1 + h_y | y) - 1 = s \text{ for } z < 1 - h_y \\

z_2 = 1 -   h_y + \Phi(s | y)\\
z_2 - 1 + h_y =  \Phi(s | y)\\
\Phi^{-1}(z_2 - 1 + h_y) = s \text{ for } z \geq 1 - h_y \\
$$
$$
C^{-1}_{\phi,f_3}(x | y) = \begin{cases}
\Phi^{-1}(x + h_y | y) - 1  & \text{ for } x < 1 - h_y \\
\Phi^{-1}(x - 1 + h_y) & \text{ otherwise } 
\end{cases}
$$

$$
q_{\phi,f_3}(x | 0) = \begin{cases}
  \frac{1}{4} - \left(\Phi^{-1}(x + h_0 | 0) - 1 \right)^2 & \text{for }  x < 1 - h_0 \\
  \frac{1}{4} + 2 \Phi^{-1}(x - 1 + h_0) - \left( \Phi^{-1}(x - 1 + h_0)\right)^2  & \text{ otherwise } 
\end{cases}
\\
q_{\phi,f_3}(x | 1) = \begin{cases}
  \frac{3}{4} + 2\Phi^{-1}(x + h_1 | 1) - 2 + \left(\Phi^{-1}(x + h_1 | 1) - 1 \right)^2 & \text{for }  x < 1 - h_1 \\
  \frac{3}{4} + \left( \Phi^{-1}(x - 1 + h_1)\right)^2  & \text{ otherwise } 
\end{cases}
$$

So the SBC condition is:

$$
x = \begin{cases}
-4 + 2 \Phi^{-1}(x + h_0 | 0) - \left(\Phi^{-1}(x + h_0 | 0)\right)^2 + 2\Phi^{-1}(x + h_1 | 1) -2 \Phi^{-1}(x + h_1 | 1) + \left(\Phi^{-1}(x + h_1 | 1)  \right)^2
\end{cases}
$$


