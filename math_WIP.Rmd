---
title: "R Notebook"
output: html_notebook
---

## Definitions

Note on notation: we will denote the integral of $f(x)$ w.r.t $x$ over domain $X$ as $\int_X \mathrm{d}x \: f(x)$.

$$
\pi_{\text{joint}}(y, \theta) = \pi_{\text{obs}}(y | \theta) \pi_\text{prior}(\theta)\\
\pi_\text{marg}\left(y \right) = \int_\Theta \mathrm{d} \theta \: \pi_{\text{obs}}(y | \theta) \pi_\text{prior}(\theta)\\
\pi_{\text{post}}(\theta | y) = \frac{\pi_{\text{obs}}(y | \theta) \pi_\text{prior}(\theta)}{\pi_\text{marg}\left(y \right)}
$$

Alternate $q$ def:

Given a model, fitting algorithm and a function $f$, we define fitted pushforward CDF

$$
C_{\phi,f}(s | y) = \int_{\Theta}\mathrm{d}\theta\mathbb{\,I}\left[f\left(\theta, y \right) \leq s\right]\phi\left(\theta | y\right)
$$ 

and true pushforward CDF 

$$
C_{f}\left( s | y\right)=\int_{\Theta}\mathrm{d}\theta\mathbb{\,I}\left[f\left(\theta, y \right) \leq s\right]\pi_{\text{post}}(\theta | y)  \\


$$

Where $\mathbb{I}$ is the indicator function

$$
D_{\phi,f}(s | y) = \int \mathrm{d}\theta \: \phi(\theta | y) \mathbb{I}\left[ f(\theta, y) = s \right]
$$


For fixed $\tilde\theta$ and $y$ we define the continuous rank CDF
$r_{\phi,f}(x, \tilde\theta | y)$ as

$$
e \sim \text{Uniform}_c(0, 1)\\
r_{\phi,f}(x, \tilde\theta | y) = 
\mathbb{P}\left(C_{\phi,f} \left(f \left(\tilde\theta, y \right) | y \right) - e D_{\phi,f} \left(f \left(x, \tilde\theta, y \right) | y \right) < x\right)
$$

where $\text{Uniform}_c$ is the continous uniform distribution.

$$
r_{\phi,f}(x, \tilde\theta | y) = 
\begin{cases}
  0 & \text{if } x < C_{\phi,f} \left(f \left(\tilde\theta, y \right) | y \right) - D_{\phi,f} \left(f \left(\tilde\theta, y \right) | y \right) \\
  1 - \frac{C_{\phi,f} \left(f \left(\tilde\theta, y \right) | y \right) - x}{D_{\phi,f} \left(f \left(\tilde\theta, y \right) | y \right)} & 
    \text{if } D_{...} > 0 \text{ and } C_{\phi,f} \left(f \left(\tilde\theta, y \right) | y \right) - D_{\phi,f} \left(f \left(\tilde\theta, y \right) | y \right) \leq x < C_{\phi,f} \left(f \left(\tilde\theta, y \right) | y \right) \\
  1 & \text{if } x \geq C_{\phi,f} \left(f \left(\tilde\theta, y \right) \right) 
\end{cases} =
$$

TODO: figure out exact inequalities above

```{r}
x <- 0.2
f <- 1

c_phi <- function(x) { pbinom(x, size = 2, prob = 0.5) }

inv_c_phi <- function(x) { qbinom(x, size = 2, prob = 0.5) }

inv_c_m_d_phi <- function(x) { }


```


$$
q_{\phi,f}(x|y) = 
\int_\Theta \mathrm{d} \tilde\theta \: \pi_\text{post}(\tilde\theta | y) r_{\phi,f}(x, \tilde\theta | y)\\

$$


If I end up needing it, I can make it look better (https://discourse.mc-stan.org/t/sbc-math-proofs/27655/12?u=martinmodrak) but that might in fact end up not being necessary.

$$
q\left(x\mid y\right)=C_{f}\left(s\mid y\right)+\frac{D_{f}\left(s\mid y\right)}{D_{\phi,f}\left(s\mid y\right)}\left(x-C_{\phi,f}\left(s\mid y\right)\right) \\
s=\sup\left\{ s^{\prime}:C_{\phi,f}\left(s^{\prime}\mid y\right)<x\right\}
$$

Presumably, my definition of $C^{-1}$ consistent with Niko's $s$? 

$$
C^{-1}_{\phi,f}(x | y) = \inf\{ s^{\prime} : x \leq C_{\phi, f}(s^{\prime} | y)\} \\
s=\sup\left\{ s^{\prime}:C_{\phi,f}\left(s^{\prime}\mid y\right)<x\right\}
$$

Almost!

### Sample-based

$$
R_{\phi,f}(i, \tilde\theta, y) = \mathbb{P} \left(N_{\mathtt{less}} + K \leq i \right) \\

Q_{\phi,f}(i | y) = \int_\Theta \mathrm{d}\tilde\theta \: \pi_\text{post}(\tilde\theta|y)  R_{\phi,f}(i, \tilde\theta, y)
$$

passes sample-based SBC iff

$$
\forall i \in 0, \dots, M - 1: \int_Y \: \mathrm{d}y \: Q_{\phi,f}(i |y) \pi_\text{marg}(y) = \frac{i+1}{M + 1}
$$

Equivalence with the procedural definition:

$$
\int_Y \: \mathrm{d}y \: Q_{\phi,f}(i |y) \pi_\text{marg}(y) = 
\int_Y \: \mathrm{d}y  \int_\Theta \mathrm{d}\tilde\theta \: \pi_\text{post}(\tilde\theta|y)  R_{\phi,f}(i, \tilde\theta, y) \pi_\text{marg}(y) = \\
\int_\Theta \mathrm{d}\tilde\theta   \int_Y \: \mathrm{d}y \: \pi_\text{prior}(\tilde\theta)\pi_\text{lik}(y | \tilde\theta)  R_{\phi,f}(i, \tilde\theta, y) (y)


$$

## Ties/no ties correspondance

A posterior family $\phi$ has ties w.r.t model $\pi$ and function $f$ when 

$$
\int_Y \mathrm{d}y \int_\Theta \mathrm{d} \tilde\theta D_{\phi,f}(f(\tilde\theta,y) | y) > 0
$$

Given a posterior family $\phi$ which has ties wrt model $\pi$ and function $f$ we can construct a model $\pi^\prime$, posterior family $\phi^\prime$ and function $f^\prime$ such that $\phi^\prime$ has no ties wrt $\pi^\prime$ and $f^\prime$ and


$$
\forall y \in Y, x \in [0,1]: q^\pi_{\phi,f}(x | y) = q^{\pi^\prime}_{\phi,f}(x | y) \\
\forall y \in Y, i \in 0, \dots, M - 1: Q^\pi_{\phi,f}(i | y) = Q^{\pi^\prime}_{\phi,f}(i | y)
$$

The construction:

For each $y$ there can only be countable number of collisions with positive probability. So we can define:

$$
W_{\phi,f}(y) = \{w : D_{\phi,f}(w | y) > 0 \} \\
L_{\phi,f}(s, y) = |\{w \in W_{\phi,f}(y) | w < s\}|
$$

$$
\Theta^\prime = \Theta \times [0, 1] \\
\pi^\prime_\text{joint}(y, \theta, u) =  \pi_\text{joint}(y, \theta) \\
\phi^\prime(\theta, u, y) = \phi(\theta, y) \\
f^\prime(\theta, u, y) = \begin{cases}
f(\theta,y) + L_{\phi,f}(\theta,y) + u& \text{if } f(\theta,y) \in W_{\phi,f}(y) \\
f(\theta,y) + L_{\phi,f}(\theta,y) & \text{otherwise}
\end{cases}
$$

By inspection, there are no ties. The ordering of non-colliding elements hasn't changed and the order among those previously equal is uniformly random. 

Additionally $\phi = \pi_{post}$ if and only if $\phi^\prime = \pi^\prime_\text{post}$.

## Correct posterior passes continuous SBC

outline: $C_f(C^{-1}_f(x|y)|y)$ is for a given $y$ either identity or "blocky". The tiebraking exactly removes the blocks, so we have the stronger condition

$$
\phi = \pi_{post}: 
\forall y \in Y, x \in [0,1] : q_{\phi,f}(x|y) = x
$$

Presumably, if the above condition holds, than it also holds for any transform of $f$, even if the posterior is incorrect (TODO check).



## Continuous SBC imples sample SBC

By contradiction: if sample ranks are non-uniform, there has to be some $x: \int_Y \mathrm{d} y: q_{\phi,f}(x|y) \neq x$.

take lowest $k$ where 

$$
\mathbf{P}(N_\text{less} + K = k) \neq \frac{1}{M + 1}
$$

$$
\mathbb{E}(K|y) = \int_\Theta \mathrm{d}\theta \pi(\theta|y) \sum_{i=0}^M \mathtt{binomial\_pmf}\left(i | D_{\phi,f} \left(f \left(\theta, y \right) | y \right), M \right)\frac{i}{2}  = \\
\int_\Theta \mathrm{d}\theta \:\pi(\theta|y) \frac{D_{\phi,f} \left(f \left(\theta, y \right) | y \right) M}{2}
\\
\mathbb{E}(N_\text{less}|y) = M\int_0^1 \mathrm{d}x C_{\phi,f}(C^{-1}_f(x | y) | y)
$$

Case 1

$$
\mathbb{P}(N_\text{less} + K \leq k) > \frac{k}{M + 1}
$$

I choose $\tilde\theta$




## Sample SBC for all $M$ implies continuous SBC

Prove that $q$ is the limit of fractional rank distribution as $M \to \infty$

## Integral representation of SBC

$$
  \forall x \in [0,1]: \notag\\ 
  \int_Y \mathrm{d}y \int_\Theta \mathrm{d} \tilde\theta \:
  \mathbb{I}\left[
  \int_\Theta \mathrm{d}\theta \: \left(\mathbb{I}[f(\theta, y) < f(\tilde\theta, y)] \phi(\theta, y)\right)  < x
  \right]  \pi(y | \tilde\theta) \pi(\tilde\theta) = x
$$

## Convex combinations

$$
  \int_Y \mathrm{d}y \int_\Theta \mathrm{d} \tilde\theta \:
  \mathbb{I}\left[
  \int_\Theta \mathrm{d}\theta \: \left(\mathbb{I}[f(\theta, y) < f(\tilde\theta, y)] (a\phi(\theta, y) + (1-a)\omega(\theta, y))\right)  < x
  \right]  \pi(y | \tilde\theta) \pi(\tilde\theta) = \\
  \int_Y \mathrm{d}y \int_\Theta \mathrm{d} \tilde\theta \:
  \mathbb{I}\left[
  a\int_\Theta \mathrm{d}\theta \: \left(\mathbb{I}[f(\theta, y) < f(\tilde\theta, y)] \phi(\theta, y)\right) +
  (1 - a)\int_\Theta \mathrm{d}\theta \: \left(\mathbb{I}[f(\theta, y) < f(\tilde\theta, y)] \omega(\theta, y)\right)  < x
  \right]  \pi(y | \tilde\theta) \pi(\tilde\theta) =   
$$

## Non-monotonous functions - simple case

Take $\Theta = \mathbb{R}$ and $\text{id} : Y \times \mathbb R \to \mathbb{R}, \text{id}(y, \theta) = \theta$   $C_\text{id}(s|y)$ is invertible over the domain of $f$ for all $y$. Take any continuous, almost everywhere smooth bijection $u: [0,1] \to [0,1], u(0) = 0, u(1) = 1$ and disjoint $Y_1, Y_2 \subset Y$ (with non-zero mass).  

$$
a,b \in [0,1]\\
\frac{a}{b} = \frac{\int_{y \in Y_2} \mathrm{d}y \: \pi_\text{marg}(y)}{\int_{y \in Y_1} \mathrm{d}y \: \pi_\text{marg}(y)}
$$

$$
v(x) = a u(x) + (1-a)x\\
w(x) = b (2x - u(x)) + (1-b)x\\

t_1(\theta, y) =  C^{-1}_\text{id}(v(C_\text{id}(\theta|y)) | y)\\
t_2(\theta, y) =  C^{-1}_\text{id}(w(C_\text{id}(\theta|y)) | y)
$$

$$
C^{-1}_\text{id}(v_i(C_\text{id}(\theta|y)) | y) = x \\
v_i(C_\text{id}(\theta|y)) = C_\text{id}(x |y) \\
C_\text{id}(\theta|y) = v^{-1}(C_\text{id}(x |y)) \\
\theta = C^{-1}_\text{id}(v^{-1}(C_\text{id}(x |y)) | y) \\
$$

$t_{1,2}$ are invertible and we can define:

TODO: Omega and w are similar visually, change

$$
\omega(\theta|y) = \begin{cases}
  \pi_\text{post}(t^{-1}_1(\theta,y)|y) \frac{\partial t^{-1}_1}{\partial \theta}(\theta, y) | y) & \text{if } y \in Y_1 \\
  \pi_\text{post}(t^{-1}_2(\theta,y)|y) \frac{\partial t^{-1}_2}{\partial \theta}(\theta, y) | y) & \text{if } y \in Y_2 \\
  \pi_\text{post}(\theta | y) & \text{otherwise}
\end{cases}
$$

now $\omega$ satisfies SBC for $\text{id}$.


$$
y \in Y_1: C_{\omega,\text{id}}(s|y) = \int_{\Theta}\mathrm{d}\theta\mathbb{\,I}\left[\theta \leq s\right]\omega\left(\theta | y\right) = \\
\int_{\Theta}\mathrm{d}\theta\mathbb{\,I}\left[\theta \leq s\right]\pi_\text{post}(t^{-1}_1(\theta,y)|y) \frac{\partial t^{-1}_1}{\partial \theta}(\theta, y) | y) = \\
= \int_{\Theta}\mathrm{d}\bar\theta\mathbb{\,I}\left[t_1(\theta,y) \leq s\right]\pi_\text{post}(\bar\theta,y) = C_{t_1}(s|y) \\


$$

$$
y \in Y_1: q_{\omega,\text{id}}(x | y) = C_\text{id} \left(C^{-1}_{\omega,\text{id}}(x | y) | y \right) =
  C_\text{id} \left(C^{-1}_{t_1}(x | y) | y \right) = 
  \int \mathrm{d}\theta \: \mathbb{I}\left[\theta< C^{-1}_{t_1}(x | y)\right]\pi_\text{post}(\theta|y) = \\
  = \int \mathrm{d}\theta \: \mathbb{I}\left[C_{t_1}(\theta |y)< x\right]\pi_\text{post}(\theta|y) = \\
  = \int \mathrm{d}\theta \: \mathbb{I}\left[\int \mathrm{d}\tilde\theta\: \mathbb{I}\left[t_1(\tilde\theta, y) < \theta \right] \pi_\text{post}(\tilde\theta|y) < x\right]\pi_\text{post}(\theta|y) = \\
  = \int \mathrm{d}\theta \: \mathbb{I}\left[\int \mathrm{d}\tilde\theta\: \mathbb{I}\left[\tilde\theta < t_1^{-1}(\theta, y) \right] \pi_\text{post}(\tilde\theta|y) < x\right]\pi_\text{post}(\theta|y) = \\
  = \int \mathrm{d}\theta \: \mathbb{I}\left[C_\text{id}(t_1^{-1}(\theta, y)|y) < x\right]\pi_\text{post}(\theta|y) = \\
  = \int \mathrm{d}\theta \: \mathbb{I}\left[\theta < t_1(C^{-1}_\text{id}(x|y)\right]\pi_\text{post}(\theta|y) = \\
  = C_\text{id}\left(t_1(C_\text{id}^{-1}(x|y), y) \right) = v(x)
  
$$

Analogously

$$
y \in Y_2: q_{\omega,\text{id}}(x | y)  = w(x)
$$
So we have 

$$
\int_Y \mathrm{d}y \: q_{\omega,\text{id}}(x | y) \pi_\text{marg}(y) = \\
\int_{Y_1} \mathrm{d}y \: q_{\omega,\text{id}}(x | y) \pi_\text{marg}(y) + \int_{Y_2} \mathrm{d}y \: q_{\omega,\text{id}}(x | y) \pi_\text{marg}(y) + \int_{Y \setminus Y_1 \cup Y_2} \mathrm{d}y \: q_{\omega,\text{id}}(x | y) \pi_\text{marg}(y) = \\
v(x) \int_{Y_1} \mathrm{d}y \: \pi_\text{marg}(y) + w(x)\int_{Y_2} \mathrm{d}y\pi_\text{marg}(y) + x \int_{Y \setminus Y_1 \cup Y_2} \mathrm{d}y \: \pi_\text{marg}(y) = \\
(a u(x) + (1-a)x)\int_{Y_1} \mathrm{d}y \: \pi_\text{marg}(y) + (b (2x - u(x)) + (1-b)x)\int_{Y_2} \mathrm{d}y\pi_\text{marg}(y) + x \int_{Y \setminus Y_1 \cup Y_2} \mathrm{d}y \: \pi_\text{marg}(y) =\\
u(x) a \int_{Y_1} \mathrm{d}y \: \pi_\text{marg}(y) + b(2x - u(x)) \int_{Y_2} \mathrm{d}y\pi_\text{marg}(y) + x \left( \int_{Y \setminus Y_1 \cup Y_2} \mathrm{d}y \: \pi_\text{marg}(y) + (1-a)\int_{Y_1} \mathrm{d}y \: \pi_\text{marg}(y) + (1-b)\int_{Y_2} \mathrm{d}y\pi_\text{marg}(y)\right) \\
$$

We note that from requirements on $a,b$ we have $a \int_{Y_1} \mathrm{d}y \: \pi_\text{marg}(y) = b \int_{Y_2} \mathrm{d}y \: \pi_\text{marg}(y)$ and $u(x) + u^{-1}(x)$ se we have

$$
\int_Y \mathrm{d}y \: q_{\omega,\text{id}}(x | y) \pi_\text{marg}(y) = \\
\left(u(x) + 2x - u(x)\right)\left( a \int_{Y_1} \mathrm{d}y \: \pi_\text{marg}(y)\right) + x \left(1 - 2a \int_{Y_1} \mathrm{d}y \: \pi_\text{marg}(y) \right) = x \\

$$

$$
u(x) + v(x) = 2x \\
v(x) = 2x - u(x)
$$

Take $\Theta = \mathbb{R}$ and $f,g: Y \times \mathbb R \to \mathbb{R}, h: \mathbb{R} \to \mathbb{R}$ such that $\forall y \in Y, \theta \in \mathbb{R}: g(\theta, y) = h(f(\theta, y)$.  $C_f(\theta|y), C_g(\theta|y)$ are invertible for all $y$. There exist bounds $l_1 \leq u_1 \leq $\Theta


Take $\Theta = \mathbb{R}$ and $f,g: Y \times \mathbb R \to \mathbb{R}, h: \mathbb{R} \to \mathbb{R}$ such that $\forall y \in Y, \theta \in \mathbb{R}: g(\theta, y) = h(f(\theta, y)$.  $C_f(\theta|y), C_g(\theta|y)$ are invertible for all $y$. There exist bounds $l_1 \leq u_1 \leq $\Theta

$disjoint $Y_1, Y_2 \subset Y$ and disjoint $\Theta_1, \Theta_2 \subset \mathbb{R}$


